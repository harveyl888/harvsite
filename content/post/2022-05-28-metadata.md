+++
author = "Harvey"
title = "Adding Metadata to R Functions"
date = "2022-05-28"
description = "Three ways to embed metadata in R functions"
tags = ["R"]
codeMaxLines = 30
draft = true
+++

This post describes three ways to tag functions with metadata.  

## Attributes

Using attributes is a simple way to add metadata to any object in R.  Data frames and other objects already use attributes to hold metadata which are accessible via the `attributes` function.

```r
df <- data.frame(a = 1:5, b = letters[1:5])

## retrieve attributes
attributes(df)
$names
[1] "a" "b"

$class
[1] "data.frame"

$row.names
[1] 1 2 3 4 5
```

Metadata can be added by simply using the `attributes` function and retrieved using `attr`.

```r
f <- function(x, y) {
    sum(x, y)
}

## add two new attributes
attributes(f) <- c(attributes(f), f = "function: sum", param_count = 2)
```

```r
## list all attributes
attributes(f)

$srcref
function(x, y) {
    sum(x, y)
}

$f
[1] "function: sum"

$param_count
[1] 2
```

```r
## retrieve a single attribute
attr(f, "param_count")
[1] 2
```

## Metadata in *comment*

Metadata can be associated with any R object using `comment`.  The comment is, in fact, simply an attribute with the limitation that it must be a character vector.  Multiple items of metadata can be attached using the `comment` function.

```r
f <- function(x, y) {
    sum(x, y)
}

comment(f) <- c(f = "function: sum", param_count = "2")
```

Once set, `comment` can be used to retrieve one of more items of metadata.

```r
comment(f)
              f     param_count 
"function: sum"             "2" 

comment(f)[["param_count"]]
[1] "2"
```

For a more complex data structure a json object can be attached.  Note that in the example below, `param_count` is a numeric as opposed to a character type imposed when using `comment` to hold a vector.

```r
f <- function(x, y) {
    sum(x, y)
}

comment(f) <- jsonlite::toJSON(list(f = "function: sum", param_count = 2), auto_unbox = TRUE)
```

```r
## retrieving metadata (comment)
comment(f)
{"f":"function: sum","param_count":2} 

jsonlite::fromJSON(comment(f))
$f
[1] "function: sum"

$param_count
[1] 2
```

## Metadata in roxygen2

Metadata can be included in custom roxygen2 tags.  Once added it can be retrieved programatically.

In order to demonstrate this method we need to build two packages - one for the custom tag and the other to demonstate its use in a function.

### Package 1 - Custom roxygen2 tag

This package consists of a number of functions to define a new roclet, `metadata` which can be used to store metadata for a function.  The R code is shown below.

```r
#' roclet to parse @metadata tag
#'
#' @import roxygen2
#' @export
metadata <- function() {
  roxygen2::roclet("metadata")
}


#' @rdname metadata
#' @importFrom roxygen2 tag_markdown
#' @export
roxy_tag_parse.roxy_tag_metadata <- function(x) {
  roxygen2::tag_markdown(x)
}


#' @rdname metadata
#' @importFrom roxygen2 rd_section
#' @export
roxy_tag_rd.roxy_tag_metadata <- function(x, base_path, env) {
  roxygen2::rd_section('metadata', x$val)
}

#' @rdname metadata
#' @export
format.rd_section_metadata <- function(x, ...) {
  paste0(
    "\\section{Metadata}{\n",
    x$value,
    "}\n"
  )
}


#' @rdname metadata
#' @export
roclet_process.roclet_metadata <- function(x, blocks, env, base_path) {
  x
}


#' @rdname metadata
#' @export
roclet_output.roclet_metadata <- function(x, results, base_path, ...) {
  x
}
```

An explanation of extending roxygen2 can be found with the [roxygen2 documentation](https://roxygen2.r-lib.org/articles/extending.html).

After running `roxygen2::roxygenize()` to document and build the `NAMESPACE` file, this package can be built and installed.

